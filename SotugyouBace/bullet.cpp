//=============================================================================
//
// 弾.cpp (Bullet.cpp)
// Author : Saito Shian
//
//=============================================================================

//=============================================================================
// インクルード
//=============================================================================
#include "application.h"
#include "renderer.h"
#include "bullet.h"
#include "game.h"
#include "meshfield.h"

//=============================================================================
// 静的メンバ変数宣言
//=============================================================================
const float CBullet::BULLET_SPEED = 15.0f;				// 弾の速度
const float CBullet::BULLET_COLLISION_RADIUS = 30.0f;	// 弾の当たり判定の大きさ
//=============================================================================
// コンストラクタ
//=============================================================================
CBullet::CBullet(const CObject::PRIORITY priority) : CObject3D(priority)
{
	m_nLife = BULLET_LIFE;
	m_fSpeed = BULLET_SPEED;
	SetRadius(BULLET_COLLISION_RADIUS);
}

//=============================================================================
// デストラクタ
//=============================================================================
CBullet::~CBullet()
{
}

//=============================================================================
// 初期化処理
//=============================================================================
HRESULT CBullet::Init()
{
	// オブジェクト3Dの初期化処理
	CObject3D::Init();

	//==================================================
	// メンバ変数の初期化
	//==================================================
	// 当たり判定の生成
	SetCollision();

	// 弾のテクスチャ
	SetTexture(CTexture::TEXTURE_BULLET);

	// ビルボードの設定
	Setbillboard(true);

	return S_OK;
}

//=============================================================================
// 終了処理
//=============================================================================
void CBullet::Uninit()
{
	// オブジェクト3Dの終了処理
	CObject3D::Uninit();
}

//=============================================================================
// 更新処理
//=============================================================================
void CBullet::Update()
{
	// 取得
	D3DXVECTOR3 pos = GetPos();
	D3DXVECTOR3 move = GetMove();

	//弾の位置更新
	pos += move * m_fSpeed;

	//前回の位置を保存
	m_nPosOld = pos;

	// 位置の設定
	SetPos(pos);

	// オブジェクト3Dの更新処理
	CObject3D::Update();

	// 寿命を減らす
	m_nLife--;
	if (m_nLife <= 0)
	{
		Uninit();
		return;
	}

	// 床の当たり判定
	FieldCollision();
}

//=============================================================================
// 描画処理
//=============================================================================
void CBullet::Draw()
{
	// オブジェクト3Dの描画処理
	CObject3D::Draw();
}

//============================================================================
// 床の当たり判定
//============================================================================
void CBullet::FieldCollision()
{
	// 現在の位置を定数として取得
	const D3DXVECTOR3 pos = GetPos();

	CMeshField* pMesfField = CGame::GetMeshField();

	// 床の当たり判定から高さを定数として取得
	const float a = pMesfField->MeshCollision(pos);

	// メッシュフィールドより下の位置にいる場合
	if (a >= pos.y)
	{
		Hit();

		pMesfField->Ground_Broken(pos, 50.0f, 5);
	}
}

//=============================================================================
// 被弾処理
//=============================================================================
void CBullet::Hit()
{
 	Uninit();
}

//=============================================================================
// 生成処理
//=============================================================================
CBullet* CBullet::Create(const D3DXVECTOR3 pos, const D3DXVECTOR2 size, D3DXVECTOR3 move, const PRIORITY priority)
{
	//クラスの生成
	CBullet* pBullet = new CBullet(priority);

	//nullチェック
	if (pBullet != nullptr)
	{
		//初期化処理
		pBullet->Init();
		//設定処理
		pBullet->SetPos(pos);
		pBullet->SetMove(move);
		pBullet->SetSize(size);
	}
	else
	{
		assert(false);
	}

	return pBullet;
}

